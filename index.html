<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор чеков Poster POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .check-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .info-item label {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }

        .info-item span {
            font-size: 16px;
            color: #212529;
        }

        .products-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 18px;
        }

        .products-list {
            padding: 0;
        }

        .product-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .product-id {
            font-size: 12px;
            color: #6c757d;
        }

        .product-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-input {
            width: 70px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        .quantity-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .price {
            min-width: 80px;
            text-align: right;
            font-weight: 600;
            color: #28a745;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .add-product {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .add-product h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .add-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }

        .actions {
            text-align: center;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Заголовок и информация о чеке -->
        <div class="header">
            <h1>Редактор чека</h1>
            <div class="check-info" id="checkInfo">
                <!-- Информация о чеке будет загружена здесь -->
            </div>
        </div>

        <!-- Загрузка -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Загрузка чека...</p>
        </div>

        <!-- Ошибка -->
        <div class="error" id="error" style="display: none;">
            <p id="errorMessage"></p>
        </div>

        <!-- Товары в чеке -->
        <div class="products-section" id="productsSection" style="display: none;">
            <div class="section-header">
                <h2>Товары в чеке</h2>
            </div>
            <div class="products-list" id="productsList">
                <!-- Товары будут загружены здесь -->
            </div>

            <!-- Итоговая сумма -->
            <div style="padding: 15px 20px; border-top: 1px solid #e9ecef; text-align: right; background: #f8f9fa;">
                <strong>Итого: <span id="totalSum" class="price"></span></strong>
            </div>

            <!-- Добавление нового товара -->
            <div class="add-product">
                <h3>Добавить товар</h3>
                <div class="add-form">
                    <div class="form-group">
                        <label>Товар</label>
                        <select class="form-control" id="productSelect">
                            <option value="">Выберите товар...</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 0 0 100px;">
                        <label>Количество</label>
                        <input type="number" class="form-control" id="productQuantity" value="1" min="1">
                    </div>
                    <button class="btn btn-primary" onclick="addProduct()">Добавить</button>
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="actions" id="actions" style="display: none;">
            <button class="btn btn-success" onclick="saveChanges()">Сохранить изменения</button>
        </div>

        <!-- Успешное сохранение -->
        <div class="success" id="success" style="display: none;">
            <p>Изменения успешно сохранены!</p>
        </div>
    </div>

    <script>
        // Конфигурация
        const API_BASE = 'https://joinposter.com/api';
        const API_TOKEN = '067911:2866713790d620e5e99b0f4bdb88c212'; // Замените на реальный токен
        const SPOT_ID = 1;
        const SPOT_TABLET_ID = 1;

        let currentTransaction = null;
        let availableProducts = [];
        let changes = {
            added: [],
            modified: [],
            removed: []
        };

        // Получение параметров из URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                transaction_id: params.get('transaction_id') || '330660' // Для тестов
            };
        }

        // API запросы
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const url = `${API_BASE}/${endpoint}?token=${API_TOKEN}`;

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Ошибка API');
                }

                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Получение чека
        async function getTransaction(transactionId) {
            return await apiRequest(`dash.getTransaction`, 'GET', {
                transaction_id: transactionId,
                include_products: true,
                include_history: false,
                include_delivery: false
            });
        }

        // Получение доступных товаров
        async function getAvailableProducts() {
            return await apiRequest(`storage.getStorageLeftovers?type=2`);
        }

        // Форматирование суммы (из копеек в рубли)
        function formatPrice(kopecks) {
            return (kopecks / 100).toFixed(2) + ' ₴';
        }

        // Форматирование даты
        function formatDate(timestamp) {
            return new Date(parseInt(timestamp)).toLocaleString('ru-RU');
        }

        // Отображение информации о чеке
        function displayCheckInfo(transaction) {
            const checkInfo = document.getElementById('checkInfo');
            const totalSum = document.getElementById('totalSum');

            checkInfo.innerHTML = `
                <div class="info-item">
                    <label>Номер чека</label>
                    <span>${transaction.transaction_id}</span>
                </div>
                <div class="info-item">
                    <label>Дата</label>
                    <span>${transaction.date_close_date || 'Открыт'}</span>
                </div>
                <div class="info-item">
                    <label>Статус</label>
                    <span>${transaction.status === '2' ? 'Закрыт' : 'Открыт'}</span>
                </div>

            `;

            totalSum.textContent = formatPrice(transaction.sum);
        }

        // Отображение товаров в чеке
        function displayProducts(products) {
            const productsList = document.getElementById('productsList');

            if (!products || products.length === 0) {
                productsList.innerHTML = '<div class="product-item">Товары не найдены</div>';
                return;
            }

            productsList.innerHTML = products.map(product => `
                <div class="product-item" data-product-id="${product.product_id}">
                    <div class="product-info">
                        <div class="product-name">Товар ID: ${product.product_id}</div>
                        <div class="product-id">Модификация: ${product.modification_id || 'Нет'}</div>
                    </div>
                    <div class="product-controls">
                        <input
                            type="number"
                            class="quantity-input"
                            value="${product.num}"
                            min="1"
                            onchange="updateProductQuantity('${product.product_id}', this.value)"
                        >
                        <div class="price">${formatPrice(product.payed_sum)}</div>
                        <button
                            class="btn btn-danger"
                            onclick="removeProduct('${product.product_id}')"
                        >
                            Удалить
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Загрузка доступных товаров в select
        function loadProductsSelect(products) {
            const select = document.getElementById('productSelect');

            select.innerHTML = '<option value="">Выберите товар...</option>';

            products.forEach(product => {
                if (product.hidden === '0') { // Только не скрытые товары
                    select.innerHTML += `
                        <option value="${product.ingredient_id}">
                            ${product.ingredient_name} (остаток: ${product.ingredient_left})
                        </option>
                    `;
                }
            });
        }

        // Изменение количества товара
        function updateProductQuantity(productId, newQuantity) {
            console.log(`Изменение количества товара ${productId} на ${newQuantity}`);

            // Добавляем в список изменений
            changes.modified.push({
                product_id: productId,
                quantity: parseInt(newQuantity)
            });
        }

        // Удаление товара
        function removeProduct(productId) {
            console.log(`Удаление товара ${productId}`);

            // Добавляем в список удаленных
            changes.removed.push({
                product_id: productId
            });

            // Удаляем из интерфейса
            const productElement = document.querySelector(`[data-product-id="${productId}"]`);
            if (productElement) {
                productElement.style.opacity = '0.5';
                productElement.style.textDecoration = 'line-through';
            }
        }

        // Добавление нового товара
        function addProduct() {
            const select = document.getElementById('productSelect');
            const quantityInput = document.getElementById('productQuantity');

            const productId = select.value;
            const quantity = parseInt(quantityInput.value);

            if (!productId) {
                alert('Выберите товар');
                return;
            }

            if (quantity < 1) {
                alert('Количество должно быть больше 0');
                return;
            }

            console.log(`Добавление товара ${productId}, количество: ${quantity}`);

            // Добавляем в список новых товаров
            changes.added.push({
                product_id: productId,
                quantity: quantity
            });

            // Сбрасываем форму
            select.value = '';
            quantityInput.value = 1;

            alert('Товар добавлен в список изменений');
        }

        // Сохранение изменений
        async function saveChanges() {
            console.log('Сохранение изменений:', changes);

            try {
                // Здесь будут реальные API вызовы
                // Пока показываем что происходит

                // Добавление новых товаров
                for (const item of changes.added) {
                    console.log('Добавляем товар:', item);
                    // const result = await apiRequest('transactions.addTransactionProduct', 'POST', {
                    //     spot_id: SPOT_ID,
                    //     spot_tablet_id: SPOT_TABLET_ID,
                    //     transaction_id: currentTransaction.transaction_id,
                    //     product_id: item.product_id
                    // });
                }

                // Изменение количества
                for (const item of changes.modified) {
                    console.log('Изменяем количество:', item);
                    // const result = await apiRequest('transactions.changeTransactionProductCount', 'POST', {
                    //     spot_id: SPOT_ID,
                    //     spot_tablet_id: SPOT_TABLET_ID,
                    //     transaction_id: currentTransaction.transaction_id,
                    //     product_id: item.product_id,
                    //     count: item.quantity
                    // });
                }

                // Удаление товаров
                for (const item of changes.removed) {
                    console.log('Удаляем товар:', item);
                    // const result = await apiRequest('transactions.removeTransactionProduct', 'POST', {
                    //     spot_id: SPOT_ID,
                    //     spot_tablet_id: SPOT_TABLET_ID,
                    //     transaction_id: currentTransaction.transaction_id,
                    //     product_id: item.product_id
                    // });
                }

                // Показываем успех
                document.getElementById('success').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('success').style.display = 'none';
                }, 3000);

                // Очищаем изменения
                changes = { added: [], modified: [], removed: [] };

            } catch (error) {
                showError('Ошибка сохранения: ' + error.message);
            }
        }

        // Показ ошибки
        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Инициализация приложения
        async function init() {
            try {
                const params = getUrlParams();

                if (!params.transaction_id) {
                    throw new Error('Не указан номер чека');
                }

                console.log('Загрузка чека:', params.transaction_id);

                // Пока используем тестовые данные вместо реальных API вызовов
                // const transactionData = await getTransaction(params.transaction_id);
                // const productsData = await getAvailableProducts();

                // Тестовые данные
                const transactionData = {
                    response: [{
                        transaction_id: "73",
                        date_close_date: "2018-02-17 16:10:46",
                        status: "2",
                        name: "Анна",
                        sum: "2750",
                        products: [
                            {
                                product_id: "162",
                                modification_id: "0",
                                num: "1",
                                product_price: "1050",
                                payed_sum: "1050"
                            },
                            {
                                product_id: "161",
                                modification_id: "0",
                                num: "1",
                                product_price: "1700",
                                payed_sum: "1700"
                            }
                        ]
                    }]
                };

                const productsData = {
                    response: [
                        {
                            ingredient_id: "1901",
                            ingredient_name: "22Р-55 - саджанець",
                            ingredient_left: "10.0000000",
                            ingredients_type: "2",
                            hidden: "0"
                        },
                        {
                            ingredient_id: "1902",
                            ingredient_name: "22Р-55 - черенок",
                            ingredient_left: "5.0000000",
                            ingredients_type: "2",
                            hidden: "0"
                        }
                    ]
                };

                currentTransaction = transactionData.response[0];
                availableProducts = productsData.response;

                // Отображаем данные
                displayCheckInfo(currentTransaction);
                displayProducts(currentTransaction.products);
                loadProductsSelect(availableProducts);

                // Показываем интерфейс
                document.getElementById('loading').style.display = 'none';
                document.getElementById('productsSection').style.display = 'block';
                document.getElementById('actions').style.display = 'block';

            } catch (error) {
                console.error('Ошибка инициализации:', error);
                document.getElementById('loading').style.display = 'none';
                showError('Ошибка загрузки: ' + error.message);
            }
        }

        // Запуск приложения
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>