<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор чеков Poster POS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0, padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #007bff; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; }
        .info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .info-item { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; }
        .info-item label { font-size: 12px; opacity: 0.8; display: block; }
        .info-item span { font-size: 16px; font-weight: bold; }
        .products { margin: 20px 0; }
        .product { display: flex; align-items: center; gap: 15px; padding: 15px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; }
        .product-name { flex: 1; font-weight: bold; }
        .quantity { width: 70px; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        .price { width: 100px; text-align: right; color: #28a745; font-weight: bold; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; padding: 15px 30px; font-size: 16px; }
        .total { text-align: right; margin: 20px 0; font-size: 20px; font-weight: bold; color: #28a745; }
        .loading { text-align: center; padding: 50px; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .add-form { display: flex; gap: 10px; align-items: end; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Редактор чека Poster POS</h1>
            <div id="checkInfo" class="info">
                <!-- Информация о чеке -->
            </div>
        </div>

        <div id="loading" class="loading">
            <p>Загрузка чека...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="products">
                <h3>Товары в чеке:</h3>
                <div id="productsList"></div>
            </div>
            
            <div class="total">
                Итого: <span id="totalSum">0.00 ₴</span>
            </div>

            <div class="add-form">
                <div class="form-group">
                    <label>Добавить товар:</label>
                    <select class="form-control" id="productSelect">
                        <option value="">Выберите товар...</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 0 0 100px;">
                    <label>Количество:</label>
                    <input type="number" class="form-control" id="productQuantity" value="1" min="1">
                </div>
                <button class="btn btn-success" onclick="addProduct()">Добавить</button>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" onclick="saveChanges()">Сохранить изменения</button>
            </div>
        </div>
    </div>

    <script>
        // БЛОКИРУЕМ ВСЮ АНАЛИТИКУ
        (function() {
            const block = () => Promise.resolve(new Response('{}', {status: 200}));
            const blockProp = () => {};
            
            window.gtag = blockProp;
            window.fbq = blockProp;
            window.ga = blockProp;
            window.dataLayer = [];
            window._gaq = [];
            
            // Перехватываем fetch
            const originalFetch = window.fetch;
            window.fetch = function(url) {
                if (typeof url === 'string' && (
                    url.includes('collect') || 
                    url.includes('gtm') || 
                    url.includes('analytics') ||
                    url.includes('clarity') ||
                    url.includes('pixel') ||
                    url.includes('facebook')
                )) {
                    return block();
                }
                return originalFetch.apply(this, arguments);
            };
        })();

        const API_BASE = 'http://localhost:8080/api-proxy.php';
        
        let transaction = null;
        let products = [];
        let changes = { added: [], modified: [], removed: [] };

        function getTransactionId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('transaction_id') || '73';
        }

        function formatPrice(kopecks) {
            return (kopecks / 100).toFixed(2) + ' ₴';
        }

        async function loadData() {
            try {
                const tid = getTransactionId();
                console.log('Загружаем чек:', tid);
                
                // Загружаем чек
                const transUrl = `${API_BASE}?endpoint=dash.getTransaction&transaction_id=${tid}&include_products=true`;
                const transResponse = await fetch(transUrl);
                const transData = await transResponse.json();
                
                if (!transData.response || !transData.response[0]) {
                    throw new Error('Чек не найден');
                }
                
                transaction = transData.response[0];
                console.log('Чек загружен');
                
                // Загружаем товары
                const prodUrl = `${API_BASE}?endpoint=menu.getProducts`;
                const prodResponse = await fetch(prodUrl);
                const prodData = await prodResponse.json();
                
                products = prodData.response || [];
                console.log('Товары загружены:', products.length);
                
                displayAll();
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('error').textContent = 'Ошибка загрузки: ' + error.message;
                document.getElementById('error').style.display = 'block';
            }
            
            document.getElementById('loading').style.display = 'none';
        }

        function displayAll() {
            // Информация о чеке
            document.getElementById('checkInfo').innerHTML = `
                <div class="info-item">
                    <label>Номер чека</label>
                    <span>${transaction.transaction_id}</span>
                </div>
                <div class="info-item">
                    <label>Дата</label>
                    <span>${transaction.date_close_date || 'Открыт'}</span>
                </div>
                <div class="info-item">
                    <label>Статус</label>
                    <span>${transaction.status === '2' ? 'Закрыт' : 'Открыт'}</span>
                </div>
            `;

            // Товары в чеке
            const productsList = document.getElementById('productsList');
            if (transaction.products && transaction.products.length > 0) {
                productsList.innerHTML = transaction.products.map(product => {
                    const productInfo = products.find(p => p.product_id === product.product_id);
                    const name = productInfo ? productInfo.product_name : `Товар ID: ${product.product_id}`;
                    const price = product.payed_sum || (product.product_price * product.num);
                    
                    return `
                        <div class="product" data-id="${product.product_id}">
                            <div class="product-name">${name}</div>
                            <input type="number" class="quantity" value="${product.num}" min="1" 
                                   onchange="updateQuantity('${product.product_id}', this.value)">
                            <div class="price">${formatPrice(price)}</div>
                            <button class="btn btn-danger" onclick="removeProduct('${product.product_id}')">Удалить</button>
                        </div>
                    `;
                }).join('');
            } else {
                productsList.innerHTML = '<p>Товары не найдены</p>';
            }

            // Список товаров для добавления
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Выберите товар...</option>';
            products.forEach(product => {
                if (product.hidden === '0' && product.spots) {
                    const spot = product.spots.find(s => s.spot_id === '1');
                    if (spot) {
                        select.innerHTML += `
                            <option value="${product.product_id}">
                                ${product.product_name} - ${formatPrice(spot.price)}
                            </option>
                        `;
                    }
                }
            });

            // Итоговая сумма
            document.getElementById('totalSum').textContent = formatPrice(transaction.sum);

            // Показываем контент
            document.getElementById('content').style.display = 'block';
            console.log('Интерфейс отображен');
        }

        function updateQuantity(productId, newQuantity) {
            console.log('Изменение количества:', productId, newQuantity);
            const existing = changes.modified.find(item => item.product_id === productId);
            if (existing) {
                existing.quantity = parseInt(newQuantity);
            } else {
                changes.modified.push({ product_id: productId, quantity: parseInt(newQuantity) });
            }
        }

        function removeProduct(productId) {
            console.log('Удаление товара:', productId);
            changes.removed.push({ product_id: productId });
            const element = document.querySelector(`[data-id="${productId}"]`);
            if (element) {
                element.style.opacity = '0.5';
                element.style.textDecoration = 'line-through';
            }
        }

        function addProduct() {
            const select = document.getElementById('productSelect');
            const quantityInput = document.getElementById('productQuantity');
            
            if (!select.value) {
                alert('Выберите товар');
                return;
            }
            
            changes.added.push({
                product_id: select.value,
                quantity: parseInt(quantityInput.value)
            });
            
            console.log('Товар добавлен:', select.value);
            alert('Товар добавлен! Нажмите "Сохранить изменения"');
            
            select.value = '';
            quantityInput.value = 1;
        }

        async function saveChanges() {
            console.log('Сохранение изменений:', changes);
            alert('Изменения будут сохранены через API Poster POS');
        }

        // Запуск приложения
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
